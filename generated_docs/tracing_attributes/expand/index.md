*[tracing_attributes](../index.md) / [expand](index.md)*

---

# Module `expand`

## Contents

- [Structs](#structs)
  - [`AsyncInfo`](#asyncinfo)
  - [`IdentAndTypesRenamer`](#identandtypesrenamer)
  - [`ImplTraitEraser`](#impltraiteraser)
- [Enums](#enums)
  - [`RecordType`](#recordtype)
  - [`AsyncKind`](#asynckind)
- [Functions](#functions)
  - [`gen_function`](#gen-function)
  - [`gen_block`](#gen-block)
  - [`param_names`](#param-names)
  - [`path_to_string`](#path-to-string)
  - [`erase_impl_trait`](#erase-impl-trait)

## Quick Reference

| Item | Kind | Description |
|------|------|-------------|
| [`AsyncInfo`](#asyncinfo) | struct |  |
| [`IdentAndTypesRenamer`](#identandtypesrenamer) | struct | A visitor struct to replace idents and types in some piece of code (e.g. the "self" and "Self" tokens in user-supplied fields expressions when the function is generated by an old version of async-trait). |
| [`ImplTraitEraser`](#impltraiteraser) | struct |  |
| [`RecordType`](#recordtype) | enum | Indicates whether a field should be recorded as `Value` or `Debug`. |
| [`AsyncKind`](#asynckind) | enum | The specific async code pattern that was detected |
| [`gen_function`](#gen-function) | fn | Given an existing function, generate an instrumented version of that function |
| [`gen_block`](#gen-block) | fn | Instrument a block |
| [`param_names`](#param-names) | fn |  |
| [`path_to_string`](#path-to-string) | fn |  |
| [`erase_impl_trait`](#erase-impl-trait) | fn |  |

## Structs

### `AsyncInfo<'block>`

```rust
struct AsyncInfo<'block> {
    source_stmt: &'block syn::Stmt,
    kind: AsyncKind<'block>,
    self_type: Option<syn::TypePath>,
    input: &'block syn::ItemFn,
}
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:546-552`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L546-L552)*

#### Implementations

- <span id="asyncinfo-from-fn"></span>`fn from_fn(input: &'block ItemFn) -> Option<Self>`

  Get the AST of the inner function we need to hook, if it looks like a

  manual future implementation.

  

  When we are given a function that returns a (pinned) future containing the

  user logic, it is that (pinned) future that needs to be instrumented.

  Were we to instrument its parent, we would only collect information

  regarding the allocation of that future, and not its own span of execution.

  

  We inspect the block of the function to find if it matches any of the

  following patterns:

  

  - Immediately-invoked async fn, as generated by `async-trait <= 0.1.43`:

    `async fn foo<...>(...) {...}; Box::pin(foo<...>(...))`

  

  - A function returning an async (move) block, optionally `Box::pin`-ed,

    as generated by `async-trait >= 0.1.44`:

    `Box::pin(async move { ... })`

  

  We the return the statement that must be instrumented, along with some

  other information.

  'gen_body' will then be able to use that information to instrument the

  proper function/future.

  

  (this follows the approach suggested in

  https://github.com/dtolnay/async-trait/issues/45#issuecomment-571245673)

- <span id="asyncinfo-gen-async"></span>`fn gen_async(self, args: InstrumentArgs, instrumented_function_name: &str) -> Result<proc_macro::TokenStream, syn::Error>` â€” [`InstrumentArgs`](../attr/index.md#instrumentargs)

#### Trait Implementations

##### `impl Any for AsyncInfo<'block>`

- <span id="asyncinfo-any-type-id"></span>`fn type_id(&self) -> TypeId`

##### `impl<T> Borrow for AsyncInfo<'block>`

- <span id="asyncinfo-borrow"></span>`fn borrow(&self) -> &T`

##### `impl<T> BorrowMut for AsyncInfo<'block>`

- <span id="asyncinfo-borrowmut-borrow-mut"></span>`fn borrow_mut(&mut self) -> &mut T`

##### `impl<T> From for AsyncInfo<'block>`

- <span id="asyncinfo-from"></span>`fn from(t: T) -> T`

  Returns the argument unchanged.

##### `impl<U> Into for AsyncInfo<'block>`

- <span id="asyncinfo-into"></span>`fn into(self) -> U`

  Calls `U::from(self)`.

  

  That is, this conversion is whatever the implementation of

  <code>[From]&lt;T&gt; for U</code> chooses to do.

##### `impl<U> TryFrom for AsyncInfo<'block>`

- <span id="asyncinfo-tryfrom-type-error"></span>`type Error = Infallible`

- <span id="asyncinfo-tryfrom-try-from"></span>`fn try_from(value: U) -> Result<T, <T as TryFrom>::Error>`

##### `impl<U> TryInto for AsyncInfo<'block>`

- <span id="asyncinfo-tryinto-type-error"></span>`type Error = <U as TryFrom>::Error`

- <span id="asyncinfo-tryinto-try-into"></span>`fn try_into(self) -> Result<U, <U as TryFrom>::Error>`

### `IdentAndTypesRenamer<'a>`

```rust
struct IdentAndTypesRenamer<'a> {
    types: Vec<(&'a str, syn::TypePath)>,
    idents: Vec<(syn::Ident, syn::Ident)>,
}
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:799-802`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L799-L802)*

A visitor struct to replace idents and types in some piece
of code (e.g. the "self" and "Self" tokens in user-supplied
fields expressions when the function is generated by an old
version of async-trait).

#### Trait Implementations

##### `impl Any for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-any-type-id"></span>`fn type_id(&self) -> TypeId`

##### `impl<T> Borrow for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-borrow"></span>`fn borrow(&self) -> &T`

##### `impl<T> BorrowMut for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-borrowmut-borrow-mut"></span>`fn borrow_mut(&mut self) -> &mut T`

##### `impl<T> From for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-from"></span>`fn from(t: T) -> T`

  Returns the argument unchanged.

##### `impl<U> Into for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-into"></span>`fn into(self) -> U`

  Calls `U::from(self)`.

  

  That is, this conversion is whatever the implementation of

  <code>[From]&lt;T&gt; for U</code> chooses to do.

##### `impl<U> TryFrom for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-tryfrom-type-error"></span>`type Error = Infallible`

- <span id="identandtypesrenamer-tryfrom-try-from"></span>`fn try_from(value: U) -> Result<T, <T as TryFrom>::Error>`

##### `impl<U> TryInto for IdentAndTypesRenamer<'a>`

- <span id="identandtypesrenamer-tryinto-type-error"></span>`type Error = <U as TryFrom>::Error`

- <span id="identandtypesrenamer-tryinto-try-into"></span>`fn try_into(self) -> Result<U, <U as TryFrom>::Error>`

##### `impl VisitMut for IdentAndTypesRenamer<'_>`

- <span id="identandtypesrenamer-visitmut-visit-ident-mut"></span>`fn visit_ident_mut(&mut self, id: &mut Ident)`

- <span id="identandtypesrenamer-visitmut-visit-type-mut"></span>`fn visit_type_mut(&mut self, ty: &mut Type)`

### `ImplTraitEraser`

```rust
struct ImplTraitEraser;
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:829`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L829)*

#### Trait Implementations

##### `impl Any for ImplTraitEraser`

- <span id="impltraiteraser-any-type-id"></span>`fn type_id(&self) -> TypeId`

##### `impl<T> Borrow for ImplTraitEraser`

- <span id="impltraiteraser-borrow"></span>`fn borrow(&self) -> &T`

##### `impl<T> BorrowMut for ImplTraitEraser`

- <span id="impltraiteraser-borrowmut-borrow-mut"></span>`fn borrow_mut(&mut self) -> &mut T`

##### `impl<T> From for ImplTraitEraser`

- <span id="impltraiteraser-from"></span>`fn from(t: T) -> T`

  Returns the argument unchanged.

##### `impl<U> Into for ImplTraitEraser`

- <span id="impltraiteraser-into"></span>`fn into(self) -> U`

  Calls `U::from(self)`.

  

  That is, this conversion is whatever the implementation of

  <code>[From]&lt;T&gt; for U</code> chooses to do.

##### `impl<U> TryFrom for ImplTraitEraser`

- <span id="impltraiteraser-tryfrom-type-error"></span>`type Error = Infallible`

- <span id="impltraiteraser-tryfrom-try-from"></span>`fn try_from(value: U) -> Result<T, <T as TryFrom>::Error>`

##### `impl<U> TryInto for ImplTraitEraser`

- <span id="impltraiteraser-tryinto-type-error"></span>`type Error = <U as TryFrom>::Error`

- <span id="impltraiteraser-tryinto-try-into"></span>`fn try_into(self) -> Result<U, <U as TryFrom>::Error>`

##### `impl VisitMut for ImplTraitEraser`

- <span id="impltraiteraser-visitmut-visit-type-mut"></span>`fn visit_type_mut(&mut self, t: &mut Type)`

## Enums

### `RecordType`

```rust
enum RecordType {
    Value,
    Debug,
}
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:435-440`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L435-L440)*

Indicates whether a field should be recorded as `Value` or `Debug`.

#### Variants

- **`Value`**

  The field should be recorded using its `Value` implementation.

- **`Debug`**

  The field should be recorded using `tracing::field::debug()`.

#### Implementations

- <span id="recordtype-const-types-for-value"></span>`const TYPES_FOR_VALUE: &'static [&'static str]`

- <span id="recordtype-parse-from-ty"></span>`fn parse_from_ty(ty: &Type) -> Self`

  Parse `RecordType` from [Type] by looking up

  the [RecordType::TYPES_FOR_VALUE] array.

#### Trait Implementations

##### `impl Any for RecordType`

- <span id="recordtype-any-type-id"></span>`fn type_id(&self) -> TypeId`

##### `impl<T> Borrow for RecordType`

- <span id="recordtype-borrow"></span>`fn borrow(&self) -> &T`

##### `impl<T> BorrowMut for RecordType`

- <span id="recordtype-borrowmut-borrow-mut"></span>`fn borrow_mut(&mut self) -> &mut T`

##### `impl<T> From for RecordType`

- <span id="recordtype-from"></span>`fn from(t: T) -> T`

  Returns the argument unchanged.

##### `impl<U> Into for RecordType`

- <span id="recordtype-into"></span>`fn into(self) -> U`

  Calls `U::from(self)`.

  

  That is, this conversion is whatever the implementation of

  <code>[From]&lt;T&gt; for U</code> chooses to do.

##### `impl<U> TryFrom for RecordType`

- <span id="recordtype-tryfrom-type-error"></span>`type Error = Infallible`

- <span id="recordtype-tryfrom-try-from"></span>`fn try_from(value: U) -> Result<T, <T as TryFrom>::Error>`

##### `impl<U> TryInto for RecordType`

- <span id="recordtype-tryinto-type-error"></span>`type Error = <U as TryFrom>::Error`

- <span id="recordtype-tryinto-try-into"></span>`fn try_into(self) -> Result<U, <U as TryFrom>::Error>`

### `AsyncKind<'a>`

```rust
enum AsyncKind<'a> {
    Function(&'a syn::ItemFn),
    Async {
        async_expr: &'a syn::ExprAsync,
        pinned_box: bool,
    },
}
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:533-544`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L533-L544)*

The specific async code pattern that was detected

#### Variants

- **`Function`**

  Immediately-invoked async fn, as generated by `async-trait <= 0.1.43`:
  `async fn foo<...>(...) {...}; Box::pin(foo<...>(...))`

- **`Async`**

  A function returning an async (move) block, optionally `Box::pin`-ed,
  as generated by `async-trait >= 0.1.44`:
  `Box::pin(async move { ... })`

#### Trait Implementations

##### `impl Any for AsyncKind<'a>`

- <span id="asynckind-any-type-id"></span>`fn type_id(&self) -> TypeId`

##### `impl<T> Borrow for AsyncKind<'a>`

- <span id="asynckind-borrow"></span>`fn borrow(&self) -> &T`

##### `impl<T> BorrowMut for AsyncKind<'a>`

- <span id="asynckind-borrowmut-borrow-mut"></span>`fn borrow_mut(&mut self) -> &mut T`

##### `impl<T> From for AsyncKind<'a>`

- <span id="asynckind-from"></span>`fn from(t: T) -> T`

  Returns the argument unchanged.

##### `impl<U> Into for AsyncKind<'a>`

- <span id="asynckind-into"></span>`fn into(self) -> U`

  Calls `U::from(self)`.

  

  That is, this conversion is whatever the implementation of

  <code>[From]&lt;T&gt; for U</code> chooses to do.

##### `impl<U> TryFrom for AsyncKind<'a>`

- <span id="asynckind-tryfrom-type-error"></span>`type Error = Infallible`

- <span id="asynckind-tryfrom-try-from"></span>`fn try_from(value: U) -> Result<T, <T as TryFrom>::Error>`

##### `impl<U> TryInto for AsyncKind<'a>`

- <span id="asynckind-tryinto-type-error"></span>`type Error = <U as TryFrom>::Error`

- <span id="asynckind-tryinto-try-into"></span>`fn try_into(self) -> Result<U, <U as TryFrom>::Error>`

## Functions

### `gen_function`

```rust
fn gen_function<'a, B: ToTokens + 'a>(input: crate::MaybeItemFnRef<'a, B>, args: crate::attr::InstrumentArgs, instrumented_function_name: &str, self_type: Option<&syn::TypePath>) -> proc_macro2::TokenStream
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:19-124`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L19-L124)*

Given an existing function, generate an instrumented version of that function

### `gen_block`

```rust
fn gen_block<B: ToTokens>(block: &B, params: &syn::punctuated::Punctuated<syn::FnArg, token::Comma>, async_context: bool, args: crate::attr::InstrumentArgs, instrumented_function_name: &str, self_type: Option<&syn::TypePath>) -> proc_macro2::TokenStream
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:127-432`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L127-L432)*

Instrument a block

### `param_names`

```rust
fn param_names(pat: syn::Pat, record_type: RecordType) -> Box<dyn Iterator<Item = (syn::Ident, RecordType)>>
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:500-530`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L500-L530)*

### `path_to_string`

```rust
fn path_to_string(path: &syn::Path) -> String
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:781-793`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L781-L793)*

### `erase_impl_trait`

```rust
fn erase_impl_trait(ty: &syn::Type) -> syn::Type
```

*Defined in [`tracing-attributes-0.1.31/src/expand.rs:844-848`](../../../.source_1765633015/tracing-attributes-0.1.31/src/expand.rs#L844-L848)*

